<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes | Streamly+</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="https://i.postimg.cc/G2Q6KMwj/Vibrant-Streamly-Logo-with-Play-Button.png" type="image/png">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/G2Q6KMwj/Vibrant-Streamly-Logo-with-Play-Button.png">
    <style>
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; background: #000;
            z-index: 1000; justify-content: center; align-items: center;
        }
        .trailer-content { width: 90%; max-width: 1100px; aspect-ratio: 16/9; position: relative; }
        .modal-overlay:fullscreen .trailer-content,
        .modal-overlay:-webkit-full-screen .trailer-content { width: 100vw; height: 100vh; max-width: none; }
        .close-modal { position: absolute; top: -50px; right: 0; color: white; font-size: 45px; cursor: pointer; }
        .back-button { position: fixed; top: 20px; left: 20px; color: white; font-size: 40px; text-decoration: none; z-index: 10; }
        .details-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; filter: brightness(0.25); z-index: -1; opacity: 0; transition: opacity 0.8s; }
    </style>
</head>
<body>

    <a href="app.html" class="back-button">‚Üê</a>
    <div id="movieBackground" class="details-bg"></div>

    <main class="details-container">
        <p id="statusMsg" style="color: gray;">A carregar...</p>
        <div id="movieInfo" style="display:none;">
            <h1 id="movieTitle" style="font-size: 3.5rem;"></h1>
            <p id="movieDescription" style="margin: 20px 0; line-height: 1.6; max-width: 700px;"></p>
            <div class="actions">
                <button id="playBtn" class="btn-primary">‚ñ∂ Reproduzir</button>
                <button id="trailerBtn" class="btn-secondary">üé¨ Trailer</button>
                <button id="favBtn" class="btn-secondary">+</button>
            </div>
        </div>
    </main>

    <div id="trailerModal" class="modal-overlay">
        <div class="trailer-content">
            <span class="close-modal" id="closeTrailer">&times;</span>
            <div id="trailerPlayer" style="width:100%; height:100%;"></div>
        </div>
    </div>

    <script type="module">
        import { db, auth } from './firebase-config.js';
        import { doc, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const urlParams = new URLSearchParams(window.location.search);
        const movieId = urlParams.get('id');
        let currentMovieData = null;

        async function init() {
            if (!movieId) return;

            // 1. TENTA CARREGAR DA CACHE (INSTANT√ÇNEO)
            const cached = localStorage.getItem('movie_cache');
            if (cached) {
                const movies = JSON.parse(cached);
                currentMovieData = movies.find(m => m.id === movieId);
                if (currentMovieData) renderDetails(currentMovieData);
            }

            // 2. BUSCA NO FIREBASE PARA GARANTIR DADOS ATUAIS
            try {
                const docSnap = await getDoc(doc(db, "movies", movieId));
                if (docSnap.exists()) {
                    currentMovieData = docSnap.data();
                    renderDetails(currentMovieData);
                }
            } catch (e) { console.error(e); }
        }

        function renderDetails(data) {
            const nome = data.T√≠tulo || data.Titulo || "Filme";
            document.title = `${nome} | Streamly+`;
            document.getElementById('movieTitle').innerText = nome;
            document.getElementById('movieDescription').innerText = data.Sinopse || "";
            
            const bg = document.getElementById('movieBackground');
            bg.style.backgroundImage = `url('${data.Banner}')`;
            bg.style.opacity = "1";

            document.getElementById('statusMsg').style.display = 'none';
            document.getElementById('movieInfo').style.display = 'block';
            checkFavoriteStatus();
        }

        function openPlayer(videoID) {
            if (!videoID) return alert("V√≠deo n√£o dispon√≠vel.");
            const modal = document.getElementById('trailerModal');
            document.getElementById('trailerPlayer').innerHTML = `<iframe src="https://player.vimeo.com/video/${videoID}?autoplay=1&muted=0" style="position:absolute; top:0; left:0; width:100%; height:100%;" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
            modal.style.display = 'flex';
            if (modal.requestFullscreen) modal.requestFullscreen();
            else if (modal.webkitRequestFullscreen) modal.webkitRequestFullscreen();
        }

        document.getElementById('playBtn').onclick = () => openPlayer(currentMovieData.VimeoID);
        document.getElementById('trailerBtn').onclick = () => openPlayer(currentMovieData.TrailerID);
        document.getElementById('closeTrailer').onclick = () => {
            if (document.fullscreenElement || document.webkitFullscreenElement) document.exitFullscreen?.() || document.webkitExitFullscreen?.();
            document.getElementById('trailerPlayer').innerHTML = ''; 
            document.getElementById('trailerModal').style.display = 'none';
        };

        async function checkFavoriteStatus() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const favs = userDoc.data().favorites || [];
                        document.getElementById('favBtn').innerText = favs.includes(movieId) ? "‚úì" : "+";
                    }
                }
            });
        }

        init();
    </script>
</body>
</html>
