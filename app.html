<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Início | Streamly+</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="navbar">
        <div class="logo">STREAMLY+</div>
        <nav>
            <button onclick="logout()" style="background:none; border:none; color:white; cursor:pointer; font-weight:bold;">Terminar sessão</button>
        </nav>
    </header>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Pesquisar por nome...">
    </div>

    <h2 class="section-title">Todos os Filmes</h2>
    <div id="movieGrid" class="movie-grid">
        </div>
    
    <div id="favoritesSection" style="display:none;">
        <h2 class="section-title">A Minha Lista</h2>
        <div id="favoritesList" class="movie-grid"></div>
        <hr style="border: 0.5px solid #333; margin: 0 4% 20px 4%;">
    </div>

    <script type="module">
        import { db, auth } from './firebase-config.js';
        import { collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const movieGrid = document.getElementById('movieGrid');
        const favoritesList = document.getElementById('favoritesList');
        const favoritesSection = document.getElementById('favoritesSection');
        const searchInput = document.getElementById('searchInput');

        let allMovies = [];

        // 1. CARREGAMENTO INSTANTÂNEO PELA CACHE
        const cached = localStorage.getItem('movie_cache');
        if (cached) {
            allMovies = JSON.parse(cached);
            renderMovies(allMovies);
        }

        async function loadData() {
            try {
                // Busca dados frescos em segundo plano
                const querySnapshot = await getDocs(collection(db, "movies"));
                const freshMovies = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                // Só atualiza o ecrã se os dados do Firebase forem diferentes da Cache
                if (JSON.stringify(freshMovies) !== JSON.stringify(allMovies)) {
                    allMovies = freshMovies;
                    localStorage.setItem('movie_cache', JSON.stringify(allMovies));
                    renderMovies(allMovies);
                }

                // Carregar favoritos após garantir o login
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        if (userDoc.exists()) {
                            const favIds = userDoc.data().favorites || [];
                            const favMovies = allMovies.filter(m => favIds.includes(m.id));
                            if (favMovies.length > 0) {
                                favoritesSection.style.display = 'block';
                                renderFavorites(favMovies);
                            }
                        }
                    }
                });
            } catch (e) { console.error(e); }
        }

        function renderMovies(movies) {
            movieGrid.innerHTML = movies.map(m => `
                <div class="movie-card" onclick="window.location.href='details.html?id=${m.id}'">
                    <img src="${m.Banner}" loading="lazy" alt="Banner">
                    <div class="movie-info"><h3>${m.Título || m.Titulo}</h3></div>
                </div>
            `).join('');
        }

        function renderFavorites(movies) {
            favoritesList.innerHTML = movies.map(m => `
                <div class="movie-card" onclick="window.location.href='details.html?id=${m.id}'">
                    <img src="${m.Banner}" loading="lazy">
                </div>
            `).join('');
        }

        searchInput.oninput = () => {
            const term = searchInput.value.toLowerCase();
            const filtered = allMovies.filter(m => (m.Título || m.Titulo || "").toLowerCase().includes(term));
            renderMovies(filtered);
        };

        window.logout = () => signOut(auth).then(() => window.location.href = "index.html");

        loadData();
    </script>
</body>
</html>
