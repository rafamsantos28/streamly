<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Início | Streamly+</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos rápidos para a Barra de Pesquisa e Secções */
        .search-container {
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        #searchInput {
            width: 100%;
            max-width: 500px;
            padding: 12px 20px;
            border-radius: 25px;
            border: none;
            background: #222;
            color: white;
            font-size: 16px;
            outline: none;
            border: 1px solid #444;
        }
        #searchInput:focus {
            border-color: #e50914;
        }
        .section-title {
            margin: 20px 4%;
            font-size: 1.5rem;
            color: #fff;
        }
        .movie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
            padding: 0 4% 40px 4%;
        }
        .movie-card {
            cursor: pointer;
            transition: transform 0.3s;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }
        .movie-card:hover {
            transform: scale(1.05);
            z-index: 2;
        }
        .movie-card img {
            width: 100%;
            border-radius: 8px;
            display: block;
        }
    </style>
</head>
<body>

    <header class="navbar">
        <div class="logo">STREAMLY+</div>
        <nav>
            <a href="app.html">Início</a>
            <button onclick="logout()" style="background:none; border:none; color:white; cursor:pointer; font-weight:bold;">Sair</button>
        </nav>
    </header>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Pesquisar">
    </div>

    <div id="favoritesSection" style="display:none;">
        <h2 class="section-title">A Minha Lista</h2>
        <div id="favoritesList" class="movie-grid"></div>
        <hr style="border: 0.5px solid #333; margin: 0 4% 20px 4%;">
    </div>

    <h2 class="section-title">Todos os Filmes</h2>
    <div id="movieGrid" class="movie-grid">
        <p style="padding: 20px; color: #999;">A carregar filmes...</p>
    </div>

    <script type="module">
        import { db, auth } from './firebase-config.js';
        import { collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const movieGrid = document.getElementById('movieGrid');
        const favoritesList = document.getElementById('favoritesList');
        const favoritesSection = document.getElementById('favoritesSection');
        const searchInput = document.getElementById('searchInput');

        let allMovies = [];

        // Função para carregar tudo
        async function loadData() {
            try {
                // 1. Buscar filmes do Firestore
                const querySnapshot = await getDocs(collection(db, "movies"));
                allMovies = querySnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data() 
                }));

                console.log("Filmes carregados:", allMovies);
                renderMovies(allMovies);

                // 2. Verificar utilizador logado para os favoritos
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        if (userDoc.exists()) {
                            const favIds = userDoc.data().favorites || [];
                            const favMovies = allMovies.filter(m => favIds.includes(m.id));
                            
                            if (favMovies.length > 0) {
                                favoritesSection.style.display = 'block';
                                renderFavorites(favMovies);
                            } else {
                                favoritesSection.style.display = 'none';
                            }
                        }
                    } else {
                        // Se não estiver logado, volta para o index
                        window.location.href = "index.html";
                    }
                });
            } catch (error) {
                console.error("Erro ao carregar:", error);
                movieGrid.innerHTML = "<p>Erro ao ligar ao catálogo.</p>";
            }
        }

        function renderMovies(movies) {
            if (movies.length === 0) {
                movieGrid.innerHTML = "<p>Nenhum filme encontrado.</p>";
                return;
            }
            movieGrid.innerHTML = movies.map(movie => `
                <div class="movie-card" onclick="window.location.href='details.html?id=${movie.id}'">
                    <img src="${movie.Banner || ''}" alt="Banner">
                    <div style="padding: 10px 0; font-size: 0.9rem; font-weight: bold;">
                        ${movie.Título || movie.Titulo || 'Filme sem Título'}
                    </div>
                </div>
            `).join('');
        }

        function renderFavorites(movies) {
            favoritesList.innerHTML = movies.map(movie => `
                <div class="movie-card" onclick="window.location.href='details.html?id=${movie.id}'">
                    <img src="${movie.Banner || ''}" alt="Banner">
                </div>
            `).join('');
        }

        // Lógica de Pesquisa
        searchInput.oninput = () => {
            const term = searchInput.value.toLowerCase();
            const filtered = allMovies.filter(m => {
                const titulo = (m.Título || m.Titulo || "").toLowerCase();
                return titulo.includes(term);
            });
            renderMovies(filtered);
        };

        // Função Sair
        window.logout = () => {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            });
        };

        loadData();
    </script>
</body>
</html>
